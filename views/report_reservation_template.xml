<?xml version="1.0"?>
<odoo>
    <template id="report_reservation_document">
        <t t-call="web.external_layout">
            <t t-set="o" t-value="o.with_context(lang=lang)"/>
            <!-- Project Image -->
                <div class="row mb-4">
                <div class="col-12 text-center" style="margin-top: -50px;">
                    <img t-if="o.invoice_line_ids.mapped('product_id.project_id')[0].logo" t-att-src="image_data_uri(o.invoice_line_ids.mapped('product_id.project_id')[0].logo)" style="max-height: 120px;" alt="Project Logo"/>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <!-- Left side - Client information -->
                    <div style="color: #000!important;background-color: #f1f1f1!important;padding: 16px;"> 
                        <h3 style="font-size:21px; border-bottom: 1px solid black;"><strong>Acquereur:</strong></h3>                        <div class="mt-2"><strong>Nom complet:</strong> <span t-field="o.partner_id.name"/></div>
                        <div class="mt-2"><strong>CIN:</strong> <span t-field="o.partner_id.function"/></div>
                        <div class="mt-2"><strong>Adresse:</strong> <span t-field="o.partner_id.contact_address"/></div>
                        <div class="mt-2"><strong>Téléphone:</strong> <span t-field="o.partner_id.phone"/></div>
                        <div class="mt-2"><strong>Email:</strong> <span t-field="o.partner_id.email"/></div>
                    </div>
                </div>
                <div class="col-6">
                    <!-- Right side - Sales agent information -->
                    <div style="color: #000!important;background-color: #f1f1f1!important;padding: 16px;"> 
                        <h3 style="font-size:21px; border-bottom: 1px solid black;"><strong>Representant:</strong></h3>                        <div class="mt-2"><strong>Nom complet:</strong> <span t-field="o.user_id.name"/></div>
                        <div class="mt-2"><strong>Adresse:</strong> <span t-field="o.user_id.contact_address"/></div>
                        <div class="mt-2"><strong>Téléphone:</strong> <span t-field="o.user_id.phone"/></div>
                        <div class="mt-2"><strong>Email:</strong> <span t-field="o.user_id.email"/></div>
                    </div>
                </div>
            </div>

            <div class="page">                
                <h5 style="margin-top:25px" >
                    <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">
                        Dossier N° : <span t-if="o.name != '/'" t-field="o.name"/>
                        <t t-if="o.invoice_line_ids.mapped('product_id.project_id')">
                            / <span t-field="o.invoice_line_ids.mapped('product_id.project_id')[0].name"/>
                            / <span t-field="o.invoice_line_ids.mapped('product_id.building_id')[0].name"/>
                            / <span t-field="o.invoice_line_ids.mapped('product_id')[0].name"/>
                        </t>
                    </span>
                    <span t-if="o.move_type == 'out_invoice' and o.state == 'draft'">Draft Invoice</span>
                    <span t-if="o.move_type == 'out_invoice' and o.state == 'cancel'">Cancelled Invoice</span>
                    <span t-if="o.move_type == 'out_refund'">Credit Note</span>
                    <span t-if="o.move_type == 'in_refund'">Vendor Credit Note</span>
                    <span t-if="o.move_type == 'in_invoice'">Vendor Bill</span>
                </h5>

                                <div id="informations" class="row mt-4 mb-4">
                    <div class="col-auto col-3 mw-100 mb-2" t-if="o.invoice_date" name="invoice_date">
                        <t t-if="o.move_type == 'out_invoice'"><strong>Date de réservation:</strong></t>
                        <t t-elif="o.move_type == 'out_refund'" ><strong>Credit Note Date:</strong></t>
                        <t t-elif="o.move_type == 'out_receipt'"><strong>Receipt Date:</strong></t>
                        <t t-else=""><strong>Date:</strong></t>
                        <p class="m-0" t-field="o.invoice_date"/>
                    </div>
                    <div style="display: none;" class="col-auto col-3 mw-100 mb-2" t-if="o.invoice_date_due and o.move_type == 'out_invoice' and o.state == 'posted'" name="due_date">
                        <strong>Due Date:</strong>
                        <p class="m-0" t-field="o.invoice_date_due"/>
                    </div>
                    <div class="col-auto col-3 mw-100 mb-2" t-if="o.user_id" name="user_id">
                        <strong>Vendeur:</strong>
                        <p class="m-0" t-field="o.user_id"/>
                    </div>
                    <div class="col-auto col-3 mw-100 mb-2" style="display:none;" t-if="o.invoice_origin" name="origin">
                        <strong>Source:</strong>
                        <p class="m-0" t-field="o.invoice_origin"/>
                    </div>
                    <div class="col-auto col-3 mw-100 mb-2" t-if="o.partner_id.ref" name="customer_code">
                        <strong>Customer Code:</strong>
                        <p class="m-0" t-field="o.partner_id.ref"/>
                    </div>
                    <div class="col-auto col-3 mw-100 mb-2" t-if="o.ref" name="reference">
                        <strong>Reference:</strong>
                        <p class="m-0" t-field="o.ref"/>
                    </div>
                </div>                <t t-set="display_discount" t-value="any(l.discount for l in o.invoice_line_ids)"/>
                <t t-set="has_stores" t-value="any(l.product_id.is_store for l in o.invoice_line_ids if l.product_id)"/>

                <table class="table table-sm o_main_table" name="invoice_line_table">
                    <thead>
                        <tr>
                            <th name="th_description" class="text-left"><span>Type</span></th>
                            <th name="th_description" class="text-left"><span>Désignation du bien</span></th>
                            <th name="th_quantity" class="text-right" style="display:none;"><span>Quantity</span></th>
                            <th name="th_priceunit" t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"><span>Unit Price</span></th>                            <th name="th_price_unit" t-if="display_discount" t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                <span>Disc.%</span>
                            </th>
                            <th t-if="has_stores" name="th_taxes" t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"><span>Taxes</span></th>
                            <th name="th_subtotal" class="text-right">
                                <span groups="account.group_show_line_subtotals_tax_excluded">Amount</span>
                                <span groups="account.group_show_line_subtotals_tax_included">Total Price</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="invoice_tbody">
                        <t t-set="current_subtotal" t-value="0"/>
                        <t t-set="lines" t-value="o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>

                        <t t-foreach="lines" t-as="line">
                            <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                            <t t-set="current_subtotal" t-value="current_subtotal + line.price_total" groups="account.group_show_line_subtotals_tax_included"/>                            <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                                <t t-if="not line.display_type" name="account_invoice_line_accountable">
                                    <td><span t-if="line.product_id.is_apartment">Appartement</span><span t-if="line.product_id.is_store">Magasin</span></td>
                                    <td name="account_invoice_line_name"><span t-field="line.name" t-options="{'widget': 'text'}"/></td>
                                    <td class="text-right" style="display:none;">
                                        <span t-field="line.quantity"/>
                                        <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                                    </td>
                                    <td t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                        <span class="text-nowrap" t-field="line.price_unit"/>
                                    </td>                                    <td t-if="display_discount" t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                        <span class="text-nowrap" t-field="line.discount"/>
                                    </td>
                                    <td t-if="has_stores and line.product_id.is_store" t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                        <span t-esc="', '.join(map(lambda x: (x.description or x.name), line.tax_ids))" id="line_tax_ids"/>
                                    </td>
                                    <td t-if="has_stores and not line.product_id.is_store" t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                        <!-- Empty cell for apartments when stores are present -->
                                    </td>
                                    <td class="text-right o_price_total">
                                        <span class="text-nowrap" t-field="line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                                        <span class="text-nowrap" t-field="line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                                    </td>
                                </t>
                                <t t-if="line.display_type == 'line_section'">
                                    <td colspan="99">
                                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                    </td>
                                    <t t-set="current_section" t-value="line"/>
                                    <t t-set="current_subtotal" t-value="0"/>
                                </t>
                                <t t-if="line.display_type == 'line_note'">
                                    <td colspan="99">
                                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                    </td>
                                </t>
                            </tr>

                            <t t-if="current_section and (line_last or lines[line_index+1].display_type == 'line_section')">
                                <tr class="is-subtotal text-right">
                                    <td colspan="99">
                                        <strong class="mr16">Subtotal</strong>
                                        <span t-esc="current_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                    </td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                </table>

                <div class="clearfix">
                    <div id="total" class="row">
                        <div t-attf-class="#{'col-6' if report_type != 'html' else 'col-sm-7 col-md-6'} ml-auto">
                            <table class="table table-sm" style="page-break-inside: avoid;">
                                <tr class="border-black o_subtotal" style="">
                                    <td><strong>Subtotal</strong></td>
                                    <td class="text-right">
                                        <span t-field="o.amount_untaxed"/>
                                    </td>                                </tr>
                                <t t-if="has_stores" t-foreach="o.amount_by_group" t-as="amount_by_group">
                                    <tr style="">
                                        <t t-if="len(o.line_ids.filtered(lambda line: line.tax_line_id)) in [0, 1] and float_compare(o.amount_untaxed, amount_by_group[2], precision_rounding=o.currency_id.rounding) == 0">
                                            <td><span class="text-nowrap" t-esc="amount_by_group[0]"/></td>
                                            <td class="text-right o_price_total">
                                                <span class="text-nowrap" t-esc="amount_by_group[3]"/>
                                            </td>
                                        </t>
                                        <t t-else="">
                                            <td>
                                                <span t-esc="amount_by_group[0]"/>
                                                <span class="text-nowrap"> on
                                                    <t t-esc="amount_by_group[4]"/>
                                                </span>
                                            </td>
                                            <td class="text-right o_price_total">
                                                <span class="text-nowrap" t-esc="amount_by_group[3]"/>
                                            </td>
                                        </t>
                                    </tr>
                                </t>
                                <tr class="border-black o_total">
                                    <td><strong>Total</strong></td>
                                    <td class="text-right">
                                        <span class="text-nowrap" t-field="o.amount_total"/>
                                    </td>
                                </tr>
                                <t t-if="print_with_payments">
                                    <t t-if="o.payment_state != 'invoicing_legacy'">
                                        <t t-set="payments_vals" t-value="o.sudo()._get_reconciled_info_JSON_values()"/>
                                        <t t-foreach="payments_vals" t-as="payment_vals">
                                            <tr>
                                                <td colspan="2">
                                                    <i class="oe_form_field text-right oe_payment_label">
                                                        Payé par <t t-esc="payment_vals['journal_name']"/> le 
                                                        <t t-esc="payment_vals['date']" t-options="{&quot;widget&quot;: &quot;date&quot;}"/>
                                                    </i>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td class="text-right">
                                                    <span t-esc="payment_vals['amount']"
                                                          t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: o.currency_id}"/>
                                                </td>
                                            </tr>
                                        </t>
                                        <t t-if="len(payments_vals) &gt; 0">
                                            <tr class="border-black o_total">
                                                <td><strong>Amount Due</strong></td>
                                                <td class="text-right">
                                                    <span t-field="o.amount_residual"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </t>
                                </t>
                            </table>
                        </div>
                    </div>
                </div>
                <p t-if="o.move_type in ('out_invoice', 'in_refund') and o.payment_reference" name="payment_communication" style="display:none">
                    Please use the following communication for your payment : <b><span t-field="o.payment_reference"/></b>
                </p>
                <p t-if="o.invoice_payment_term_id" name="payment_term">
                    <span t-field="o.invoice_payment_term_id.note"/>
                </p>
                <p t-if="o.narration" name="comment">
                    <span t-field="o.narration"/>
                </p>
                <p t-if="o.fiscal_position_id.note" name="note">
                    <span t-field="o.fiscal_position_id.note"/>
                </p>
                <p t-if="o.invoice_incoterm_id" name="incoterm">
                    <strong>Incoterm: </strong><span t-field="o.invoice_incoterm_id.code"/> - <span t-field="o.invoice_incoterm_id.name"/>
                </p>                <div id="qrcode" t-if="o.display_qr_code and o.amount_residual &gt; 0">
                    <p t-if="qr_code_urls.get(o.id)">
                        <strong class="text-center">Scan me with your banking app.</strong><br/><br/>
                        <img class="border border-dark rounded" t-att-src="qr_code_urls[o.id]"/>
                    </p>
                </div>

                <!-- Payment History Table -->
                <t t-if="o.payment_state != 'invoicing_legacy'">
                    <t t-set="payments_vals" t-value="o.sudo()._get_reconciled_info_JSON_values()"/>
                    <t t-if="payments_vals">
                        <div class="row mt-4 mb-4" style="page-break-inside: avoid;">
                            <div class="col-12">
                                <table class="table table-bordered" style="margin-bottom: 20px;">
                                    <thead style="background-color: #f8f9fa;">
                                        <tr>
                                            <th class="text-center" style="padding: 12px;"><strong>Type de Paiement</strong></th>
                                            <th class="text-center" style="padding: 12px;"><strong>Ref</strong></th>
                                            <th class="text-center" style="padding: 12px;"><strong>Date</strong></th>
                                            <th class="text-center" style="padding: 12px;"><strong>Montant</strong></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="payments_vals" t-as="payment_vals">
                                            <tr>
                                                <td class="text-center" style="padding: 8px;">
                                                    <span t-esc="payment_vals['journal_name']"/>
                                                </td>
                                                <td class="text-center" style="padding: 8px;">
                                                    <span t-esc="payment_vals['ref'] or payment_vals['move_id'] or '-'"/>
                                                </td>
                                                <td class="text-center" style="padding: 8px;">
                                                    <span t-esc="payment_vals['date']" t-options="{'widget': 'date'}"/>
                                                </td>
                                                <td class="text-center" style="padding: 8px;">
                                                    <strong><span t-esc="payment_vals['amount']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></strong>
                                                </td>
                                            </tr>
                                        </t>
                                        <!-- Total row -->
                                        <tr style="background-color: #f8f9fa; border-top: 2px solid #000;">
                                            <td colspan="3" class="text-right" style="padding: 12px;"><strong>Total Payé:</strong></td>
                                            <td class="text-center" style="padding: 12px;">
                                                <strong>
                                                    <t t-set="total_paid" t-value="sum(float(p['amount']) for p in payments_vals)"/>
                                                    <span t-esc="total_paid" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                </strong>
                                            </td>
                                        </tr>
                                        <!-- Amount Due row if there's remaining balance -->
                                        <t t-if="o.amount_residual > 0">
                                            <tr style="background-color: #fff3cd; border-top: 1px solid #000;">
                                                <td colspan="3" class="text-right" style="padding: 12px;"><strong>Montant Restant:</strong></td>
                                                <td class="text-center" style="padding: 12px;">
                                                    <strong style="color: #856404;">
                                                        <span t-field="o.amount_residual"/>
                                                    </strong>
                                                </td>
                                            </tr>
                                        </t>                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>
                </t>

                <!-- Reste à payer Section -->
                <!--
                <t t-if="o.amount_residual > 0">
                    <div class="row mt-3 mb-4" style="page-break-inside: avoid;">
                        <div class="col-12">
                            <div style="background-color: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 20px; text-align: center;">
                                <h3 style="color: #721c24; margin-bottom: 15px;"><strong>RESTE À PAYER</strong></h3>
                                <div style="font-size: 28px; font-weight: bold; color: #721c24; margin-bottom: 10px;">
                                    <span t-field="o.amount_residual"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>
                -->

                <!-- Conditions de vente Section -->
                <div class="row mt-5 mb-4" style="page-break-inside: avoid;">
                    <div class="col-12">
                        <h4 style="text-align: center; margin-bottom: 20px;"><strong>Conditions de vente</strong></h4>
                        <div style="text-align: justify; line-height: 1.6; font-size: 12px; direction: rtl;">
                            <p>يصرح المستفيد على انه لا يملك أي عقار للاستعمال السكني او الثانوي او يستفيد من كراء في المملكة المغربية، ويلتزم بالأدلاء بشهادة تفيد بعدم خضوعه للضريبة على الدخل على الأملاك العقارية وكذا رسمي السكن والخدمات الاجتماعية يوم إبرام عقد الوعد بالبيع والبيع النهائي</p>
                            
                            <p>يلتزم المستفيد في حالة تغيير عنوان سكنه(ها) او رقم هاتفه (ها) بإخبار الشركة بهذا التغيير بكل وسائل الاعلام والاشهار سواء بواسطة البريد الالكتروني او رسالة مضمونة، ويتحمل كافة المسؤولية عن عدم الاخبار بالعنوان الجديد.</p>
                            
                            <p>في حالة وفاة المستفيد، يفسخ هذا الحجز دون ذعار. من اجل ذلك، يتوجب على ورثته الادلاء للطرف الاول برسم اراثة الهالك، وكذا أي وثيقة اخرى، حتى يتسنى له ارجاع مبالغ التسبيق المؤدة من طرف هذا الاخير لغرض اتفاقية التخصيص.</p>
                            
                            <p>هذا التخصيص يلزم المستفيد بشراء الملك المذكور أعلاه بصفة نهائية ولا يمكنه التنازل عنه للغير بأية طريقة.</p>
                            
                            <p>يصبح هذا التخصيص مفسوخا، والمبالغ التي بذمة المستفيد مستحقة فورا او عن اخرها مع سقوط الاجل، وذلك بعد مضي خمسة عشر يوما (15) يوما على بعث انذار للمستفيد بواسطة رسالة مضمونة مع الاشعار بالاستلام توجه اليه في موطنه المختار ولو لم يسحبها. في حالة عدم اتمام الواعد بالشراء لإجراءات اتمام البيع داخل الاجل المذكور، يرسل له المالك اشعارا جديدا للتذكير بإتمام الاجراءات في اجل اقصاه 8 ايام من تاريخ توصله به، والتي بانقضائها، سيعتبر عدم حضور الطرف الثاني تخليا من طرفه عن التخصيص، وستطبق في هذا الصدد مقتضيات المتعلقة بالتخلي عن التخصيص. وفي هذا الموضوع، يقر الطرف الثاني بموافقته على ما ذكر ويلتزم بعدم الاعتراض او المطالبة باي شيء</p>
                            
                            <p>في حالة تخلي المستفيد عن التخصيص بشكل نهائي، يكون الشركة الحق في تعويض يساوي 10 في المائة من ثمن البيع المشار إليه أعلاه أي 25000,00 DHS يأذن المستفيد اقتطاعه من مبلغ التسبيق المؤدى لهذا الأخير، قبل إرجاع ما تبقى من ذلك المبلغ، ويمنع منعا كليا التخلي للغير.</p>
                        </div>
                    </div>
                </div>

                <!-- New Signature Section before footer -->
                <div class="row mt-5 mb-5" style="page-break-inside: avoid;">
                    <div class="col-6 text-center">
                        <div style="border-top: 1px solid black; margin-top: 100px;">
                            <strong>Signature Client</strong><br/>
                            <span t-field="o.partner_id.name"/><br/>
                        </div>
                    </div>
                    <div class="col-6 text-center">
                        <div style="border-top: 1px solid black; margin-top: 100px;">
                            <strong>Signature Commercial</strong><br/>
                            <span t-field="o.user_id.name"/><br/>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Register the new report -->
    <template id="report_reservation">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="wm_real_estate.report_reservation_document"/>
            </t>
        </t>
    </template>
</odoo>
